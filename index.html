<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Calcul placements</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .container-fluid {
            padding-top: 15px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <form id="calcul" class="col-md-3">
                <div class="form-group">
                    <label for="base">Somme de base: </label>
                    <input type="number" id="form_base" class="form-control" name="base" value="3000" step="any"/>
                </div>

                <div class="form-group">
                    <label for="base">Apports mensuels: </label>
                    <input type="number" id="form_apports_mensuels" class="form-control" name="apports_mensuels" value="200"/>
                </div>

                <div class="form-group">
                    <label for="interets_versement">Interêts versement: </label>
                    <input type="number" id="form_interets_versements" class="form-control" name="interets_versement" value="1" step="any"/>
                </div>

                <div class="form-group">
                    <label for="interets_annuels">Interêts annuels: </label>
                    <input type="number" id="form_interets_annuels" class="form-control" name="interets_annuels" value="1.3" step="any"/>
                </div>

                <div class="form-group">
                    <label for="annees">Nombre d'années: </label>
                    <input type="number" id="form_annees" class="form-control" name="annees" value="5"/>
                </div>

                <input type="submit" class="btn btn-default" value="Calculer"/>
            </form>
            <div class="table-responsive col-md-5 col-md-offset-1">
                <div id="caroussel-graph" class="carousel slide" data-ride="carousel" data-interval="false">
                    <div class="carousel-inner" role="listbox">
                        <div class="item active">
                            <canvas id="graphJanvier" width="400" height="280"></canvas>
                        </div>

                        <div class="item">
                            <canvas id="graphDecembre" width="400" height="280"></canvas>
                        </div>

                        <div class="item">
                            <canvas id="graphSansPlacement" width="400" height="280"></canvas>
                        </div>

                        <div class="item">
                            <canvas id="graphInterets" width="400" height="280"></canvas>
                        </div>

                        <div class="item">
                            <canvas id="graphInteretsCumules" width="400" height="280"></canvas>
                        </div>
                    </div>
                </div>

                <nav>
                    <ul class="pagination">
                        <li><a href="#caroussel-graph" data-slide="prev"><span aria-hidden="true">&laquo;</span></a></li>
                        <li class="active"><a href="#" data-target="#caroussel-graph" data-slide-to="0">1er Jan.</a></li>
                        <li><a href="#" data-target="#caroussel-graph" data-slide-to="1">31 Déc.</a></li>
                        <li><a href="#" data-target="#caroussel-graph" data-slide-to="2">Sans placement</a></li>
                        <li><a href="#" data-target="#caroussel-graph" data-slide-to="3">Interets</a></li>
                        <li><a href="#" data-target="#caroussel-graph" data-slide-to="4">Interers cumulés</a></li>
                        <li><a href="#caroussel-graph" data-slide="next"><span aria-hidden="true">&raquo;</span></a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.5.2/randomColor.min.js"></script>

<script type="text/javascript">

    $(function() {
        $('#calcul').submit(calculerRevenus);

        graphJanvier.init();
        graphDecembre.init();
        graphSansPlacement.init();
        graphInterets.init();
        graphInteretsCumules.init();

        initPagination();
    });

    var InvestissementsGraph = function InvestissementsGraph(idCanvas, titreGraph, nomIndice){

        var self = this;

        this.idCanvas = idCanvas;
        this.titreGraph = titreGraph;
        this.nomIndice = nomIndice;

        this.graph;

        this.init = function init(){

            var config = {
                type: 'line',
                data: {
                    labels: [1, 2, 3, 4, 5],
                    datasets: []
                },
                options: {
                    responsive: true,
                    title: {
                        display:true,
                        text: self.titreGraph
                    },
                    tooltips: {
                        mode: 'label',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItem, data){

                                return [
                                   // 'Annee: ' + tooltipItem[0].xLabel,
                                    'Valeur: ' + tooltipItem[0].yLabel
                                ];
                            },
                            label: function(tooltipItem, data){
                                return data.datasets[tooltipItem.datasetIndex].label || "";
                            }
                        }
                    },
                    hover: {
                        mode: 'label',
                        intersect: false
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Année'
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: self.nomIndice
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            };

            var ctx = document.getElementById(self.idCanvas).getContext('2d');
            self.graph = new Chart(ctx, config);
        }

        this.ajouterLigne = function ajouterLigne(ligne){
            self.graph.config.data.datasets.push(ligne);
            self.graph.update();
        }

        this.setNombreAnnees = function setNombreAnnees(annees){
            if(self.graph.config.data.labels.length < annees){

                var labels = self.graph.config.data.labels;

                for(var i = labels.length +1; i <= annees; i++){
                    labels.push(i);
                }

                console.log(self.graph);
                self.graph.update();
            }
        }

        return this;
    }

    var graphJanvier = new InvestissementsGraph('graphJanvier', 'Evolution de la valeur du fond au 1er Janvier', 'Valeur du fond au 1er Janvier');
    var graphDecembre = new InvestissementsGraph('graphDecembre', 'Evolution de la valeur du fond au 31 Décembre', 'Valeur du fond au 31 Décembre');
    var graphSansPlacement = new InvestissementsGraph('graphSansPlacement', 'Evolution de la valeur du fond sans placement', 'Valeur du fond sans placement');
    var graphInterets = new InvestissementsGraph('graphInterets', 'Evolution des interets produits en fin d\'année', 'Interets produits en fin d\'année');
    var graphInteretsCumules = new InvestissementsGraph('graphInteretsCumules', 'Evolution des intérets cumulés produits par le fond', 'Intérets cumulés produits');

    var prochainIdInvestissement = 1;

    function calculerRevenus(event){
        
        event.preventDefault();
        event.stopPropagation();

        var base = parseInt($('#form_base').val()),          
            apportsMensuels = parseInt($('#form_apports_mensuels').val()),
            interetsVersements = parseFloat($('#form_interets_versements').val()) /100,
            interetsAnnuels = parseFloat($('#form_interets_annuels').val()) /100,
            annees = parseInt($('#form_annees').val());

        var depart = base,
            sansPlacement = base,
            interetsCumules = 0,
            interetsComposes = 0;

        var investColor = randomColor();
        var data = '<h5><span class="label" style="background-color: ' + investColor + '">Investissement #' + prochainIdInvestissement + '</span> Somme/mensuel ' + base + ' / ' + apportsMensuels + ', Interets versements/annuel= ' + interetsVersements *100 + '% / ' + interetsAnnuels*100 + '%</h5>';

        var html = 
            '<table class="table table-bordered table-striped table-hover">' +
                    '<caption>' + data + '</caption>' +
                    '<thead>' +
                        '<tr>' +
                            '<th>Année</th>' +
                            '<th>1er Janv.</th>' +
                            '<th>31 Déc.</th>' +
                            '<th>Sans placement</th>' +
                            '<th>Interets</th>' +
                            '<th>Interets cumulés</th>' +
                        '</tr>' +
                    '</thead>' +
                    '<tbody>';

        var ligneGraphJanvier = {
            label: 'Investissement #' + prochainIdInvestissement,
            backgroundColor: investColor,
            borderColor: investColor,
            data: [],
            fill: false
        };

        var ligneGraphDecembre = {
            label: 'Investissement #' + prochainIdInvestissement,
            backgroundColor: investColor,
            borderColor: investColor,
            data: [],
            fill: false
        };

        var ligneGraphSansPlacement = {
            label: 'Investissement #' + prochainIdInvestissement,
            backgroundColor: investColor,
            borderColor: investColor,
            data: [],
            fill: false
        };

        var ligneGraphInterets = {
            label: 'Investissement #' + prochainIdInvestissement,
            backgroundColor: investColor,
            borderColor: investColor,
            data: [],
            fill: false
        };

        var ligneGraphInteretsCumules = {
            label: 'Investissement #' + prochainIdInvestissement,
            backgroundColor: investColor,
            borderColor: investColor,
            data: [],
            fill: false
        };

        base *= (1 - interetsVersements);

        for(var i = 0; i < annees; i++){

            // Algorithme
            sansPlacement += apportsMensuels *12;

            var baseAvantVersements = base;
            base += (apportsMensuels *12) * (1 - interetsVersements);

            var baseSansInterets = base;
            base *= (1 + interetsAnnuels);

            interetsCumules += base - baseSansInterets;

            // Affichage
            var ligne = '<tr>';

            ligne += '<td>' + (i + 1) + '</td>';
            ligne += '<td>' + Math.floor(baseAvantVersements) + '</td>';
            ligne += '<td>' + Math.floor(base) + '</td>';
            ligne += '<td>' + sansPlacement + '</td>';
            ligne += '<td>' + Math.floor(base - baseSansInterets) + '</td>';
            ligne += '<td>' + Math.floor(interetsCumules) + '</td>';

            ligne += '</tr>';

            html += ligne;

            // Graph
            ligneGraphJanvier.data.push(Math.floor(baseAvantVersements));
            ligneGraphDecembre.data.push(Math.floor(base));
            ligneGraphSansPlacement.data.push(sansPlacement);
            ligneGraphInterets.data.push(Math.floor(base - baseSansInterets));
            ligneGraphInteretsCumules.data.push(Math.floor(interetsCumules));
        }

        html +=
                    '</tbody>' +
                '</table>';

        $('.table-responsive').append(html);

        graphJanvier.ajouterLigne(ligneGraphJanvier);
        graphDecembre.ajouterLigne(ligneGraphDecembre);
        graphSansPlacement.ajouterLigne(ligneGraphSansPlacement);
        graphInterets.ajouterLigne(ligneGraphInterets);
        graphInteretsCumules.ajouterLigne(ligneGraphInteretsCumules);

        graphJanvier.setNombreAnnees(annees);
        graphDecembre.setNombreAnnees(annees);
        graphSansPlacement.setNombreAnnees(annees);
        graphInterets.setNombreAnnees(annees);
        graphInteretsCumules.setNombreAnnees(annees);

        prochainIdInvestissement++;
    }

    function initPagination(){
        $(".pagination a").click(function() {

            if (!$(this).children().is("span")) {
                $(".pagination li").removeClass("active");
                $(this).parent().addClass("active");
            }
            else {
                var current = $(".pagination li.active a[data-slide-to]").parent();

                if ($(this).text() == "«") newVal = current.prev();
                else newVal = current.next();

                $(this).parent().removeClass("active");

                if (newVal.text() != "«" && newVal.text() != "»") {
                    current.removeClass("active");
                    newVal.addClass("active");
                }
                else {
                    return false;
                }
            }
        });
    }
</script>

</html>
