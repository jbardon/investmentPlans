<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Calcul placements</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .container-fluid {
            padding-top: 15px;
        }

        nav {
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <form id="calcul" class="col-md-3">
                <div class="form-group">
                    <label for="base">Somme de base: </label>
                    <input type="number" id="form_base" class="form-control" name="base" value="3000" step="any" required/>
                </div>

                <div class="form-group">
                    <label for="base">Apports mensuels: </label>
                    <input type="number" id="form_apports_mensuels" class="form-control" name="apports_mensuels" value="200" required/>
                </div>

                <div class="form-group">
                    <label for="interets_versement">Interêts versement: </label>
                    <input type="number" id="form_interets_versements" class="form-control" name="interets_versement" value="1" step="any" required/>
                </div>

                <div class="form-group">
                    <label for="interets_annuels">Interêts annuels: </label>
                    <input type="number" id="form_interets_annuels" class="form-control" name="interets_annuels" value="1.3" step="any" required/>
                </div>

                <div class="form-group">
                    <label for="annees">Nombre d'années: </label>
                    <input type="number" id="form_annees" class="form-control" name="annees" value="5" required/>
                </div>

                <input type="submit" class="btn btn-default" value="Calculer"/>
            </form>
            <div class="table-responsive col-md-5 col-md-offset-1">
                <div id="caroussel-graph" class="carousel slide" data-ride="carousel" data-interval="false">
                    <div class="carousel-inner" role="listbox">
                    </div>
                </div>

                <nav>
                    <ul class="pagination">
                        <li><a href="#caroussel-graph" data-slide="prev"><span aria-hidden="true">&laquo;</span></a></li>
                        <li><a href="#caroussel-graph" data-slide="next"><span aria-hidden="true">&raquo;</span></a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.5.2/randomColor.min.js"></script>

<script type="text/javascript">

    $(function() {
        $('#calcul').submit(calculerRevenus);

        var stats = [
            {
                nomStat: 'Janvier',
                titreTableau: '1er Janv.',
                titreGraph: 'Evolution de la valeur du fond au 1er Janvier',
                nomIndice: 'Valeur du fond au 1er Janvier'
            },
            {
                nomStat: 'Decembre',
                titreTableau: '31 Déc.',
                titreGraph: 'Evolution de la valeur du fond au 31 Décembre',
                nomIndice: 'Valeur du fond au 31 Décembre'
            },
            {
                nomStat: 'SansPlacement',
                titreTableau: 'Sans placement',
                titreGraph: 'Evolution de la valeur du fond sans placement',
                nomIndice: 'Valeur du fond sans placement'
            },
            {
                nomStat: 'Interets',
                titreTableau: 'Interets',
                titreGraph: 'Evolution des interets produits en fin d\'année',
                nomIndice: 'Interets produits en fin d\'année'
            },
            {
                nomStat: 'InteretsCumules',
                titreTableau: 'Interets cumulés',
                titreGraph: 'Evolution des intérets cumulés produits par le fond',
                nomIndice: 'Intérets cumulés produits'
            },
            {
                nomStat: 'InteretsNets',
                titreTableau: 'Interets nets',
                titreGraph: 'Evolution des intérets nets (difference sans placement)',
                nomIndice: 'Intérets nets produits'
            }
        ];

        stats.forEach(function(value, key){
            var currentGraph = new InvestissementsGraph(value.nomStat, value.titreGraph, value.nomIndice);

            var currentStat = new InvestissementStat(value.nomStat, value.titreTableau, currentGraph);
            investStats.push(currentStat);

            currentGraph.init();
        });

        initPagination();
    });

    var InvestissementsGraph = function InvestissementsGraph(nomStat, titreGraph, nomIndice){

        var self = this;

        this.nomStat = nomStat;
        this.titreGraph = titreGraph;
        this.nomIndice = nomIndice;

        this.graph = undefined;

        this.init = function init(){

            self.createGraph();

            var original = Chart.defaults.global.legend.onClick;
            Chart.defaults.global.legend.onClick = function(e, legendItem) {
                var indexInvest = legendItem.datasetIndex;
                var cacherLigne = legendItem.hidden;

                if(legendItem.hidden){
                    $('#invest-' + (indexInvest +1)).show();
                }
                else {
                    $('#invest-' + (indexInvest +1)).hide();
                }

                investStats.forEach(function(valeur, index){
                    var idCanvas = valeur.getInvestGraph().getIdCanvas();

                   if(idCanvas != e.target.id){
                       var currentGraph = valeur.getInvestGraph();
                       currentGraph.changerVisibiliteLigne(indexInvest, cacherLigne);
                   }
                });

                original.call(this, e, legendItem);
            };

            var config = {
                type: 'line',
                data: {
                    labels: [1, 2, 3, 4, 5],
                    datasets: []
                },
                options: {
                    responsive: true,
                    title: {
                        display:true,
                        text: self.titreGraph
                    },
                    tooltips: {
                        mode: 'point',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItem, data){
                                return 'Valeur: ' + tooltipItem[0].yLabel;
                            },
                            label: function(tooltipItem, data){
                                return data.datasets[tooltipItem.datasetIndex].label || "";
                            }
                        }
                    },
                    hover: {
                        mode: 'point',
                        intersect: false
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Année'
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: self.nomIndice
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            };

            var canvasId = self.getIdCanvas();
            var ctx = document.getElementById(canvasId).getContext('2d');
            self.graph = new Chart(ctx, config);
        }

        this.createGraph = function createGraph(){

            var numberCanvas = $('canvas').length;

            var canvas =
                '<div class="item' + (numberCanvas == 0 ? ' active': '') + '">' +
                    '<canvas id="' + self.getIdCanvas() + '" width="400" height="280"></canvas>' +
                '</div>';

            $('div.carousel-inner').append(canvas);

            var page =
                '<li' + (numberCanvas == 0 ? ' class="active"': '') + '>' +
                    '<a href="#" data-target="#caroussel-graph" data-slide-to="' + numberCanvas + '">' + self.nomStat + '</a>' +
                '</li>';

            $('ul.pagination li:last-child').before(page);
        };

        this.ajouterLigne = function ajouterLigne(ligne){
            self.graph.config.data.datasets.push(ligne);
            self.graph.update();
        }

        this.setNombreAnnees = function setNombreAnnees(annees){
            if(self.graph.config.data.labels.length < annees){

                var labels = self.graph.config.data.labels;

                for(var i = labels.length +1; i <= annees; i++){
                    labels.push(i);
                }

                self.graph.update();
            }
        }

        this.changerVisibiliteLigne = function changerVisibiliteLigne(ligne, visible){
            self.graph.config.data.datasets[ligne].hidden = !visible;
            self.graph.update();
        }

        this.getIdCanvas = function getIdCanvas(){
            return 'graph' + self.nomStat;
        }

        return this;
    }

    var InvestissementStat = function InvestissementStat(name, colonneTableau, graph){

        var self = this;

        this.name = name;
        this.colonneTableau = colonneTableau;
        this.graph = graph;

        this.getInvestGraph = function getInvestGraph(){
            return self.graph;
        }

        return this;
    }

    var investStats = [];

    var prochainIdInvestissement = 1;

    function calculerRevenus(event){
        
        event.preventDefault();
        event.stopPropagation();

        var base = parseInt($('#form_base').val()),          
            apportsMensuels = parseInt($('#form_apports_mensuels').val()),
            interetsVersements = parseFloat($('#form_interets_versements').val()) /100,
            interetsAnnuels = parseFloat($('#form_interets_annuels').val()) /100,
            annees = parseInt($('#form_annees').val());

        var depart = base,
            sansPlacement = base,
            interetsCumules = 0,
            interetsComposes = 0;

        var investColor = randomColor();
        var data = '<h5><span class="label" style="background-color: ' + investColor + '">Investissement #' + prochainIdInvestissement + '</span> Somme/mensuel ' + base + ' / ' + apportsMensuels + ', Interets versements/annuel= ' + interetsVersements *100 + '% / ' + interetsAnnuels*100 + '%</h5>';

        var html = 
            '<table id= "invest-' + prochainIdInvestissement + '" class="table table-bordered table-striped table-hover">' +
                    '<caption>' + data + '</caption>' +
                    '<thead>' +
                        '<tr>' +
                            '<th>Année</th>';

        investStats.forEach(function(value, key){
            html += '<th>' + value.colonneTableau + '</th>';
        });

        html +=
                        '</tr>' +
                    '</thead>' +
                    '<tbody>';

        var lignesGraph = [];

        investStats.forEach(function(value, key){
            lignesGraph.push({
                    label: 'Investissement #' + prochainIdInvestissement,
                    backgroundColor: investColor,
                    borderColor: investColor,
                    data: [],
                    fill: false
            });
        });

        base *= (1 - interetsVersements);

        for(var i = 0; i < annees; i++){

            // Algorithme
            sansPlacement += apportsMensuels *12;

            var baseAvantVersements = base;
            base += (apportsMensuels *12) * (1 - interetsVersements);

            var baseSansInterets = base;
            base *= (1 + interetsAnnuels);

            interetsCumules += base - baseSansInterets;
            var interetsNets = base - sansPlacement; 
       
            // Affichage
            var ligne = '<tr>';

            ligne += '<td>' + (i + 1) + '</td>';

            var lineValue = [
                Math.floor(baseAvantVersements),
                Math.floor(base),
                sansPlacement,
                Math.floor(base - baseSansInterets),
                Math.floor(interetsCumules),
                Math.floor(interetsNets)
            ];

            investStats.forEach(function(value, key){
                var statVal = lineValue[key];

                ligne += '<td>' + statVal + '</td>';
                lignesGraph[key].data.push(statVal);
            });

            ligne += '</tr>';

            html += ligne;
        }

        html +=
                    '</tbody>' +
                '</table>';

        $('.table-responsive').append(html);

        investStats.forEach(function(value, index){
            var graph = value.getInvestGraph();
            graph.ajouterLigne(lignesGraph[index]);
            graph.setNombreAnnees(annees);
        });

        prochainIdInvestissement++;
    }

    function initPagination(){
        $(".pagination a").click(function() {

            if (!$(this).children().is("span")) {
                $(".pagination li").removeClass("active");
                $(this).parent().addClass("active");
            }
            else {
                var current = $(".pagination li.active a[data-slide-to]").parent();

                if ($(this).text() == "«") newVal = current.prev();
                else newVal = current.next();

                $(this).parent().removeClass("active");

                if (newVal.text() != "«" && newVal.text() != "»") {
                    current.removeClass("active");
                    newVal.addClass("active");
                }
                else {
                    return false;
                }
            }
        });
    }
</script>

</html>
